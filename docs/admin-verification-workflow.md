# Admin Verification & Account Approval Workflow

## Overview

This document describes the Admin Verification & Account Approval Phase of the tenant onboarding process. This is a critical quality gate that allows administrators to verify tenant information and make approval decisions before granting system access.

## Workflow Steps

### Step 1: View Pending Inquiries

Administrators can view all tenant inquiries with the following information:
- Applicant details (name, email, phone, age)
- Number of occupants
- Unit interested
- Submission type and QR proof
- Current status (pending, verified, approved, rejected)
- Email verification status
- OTP sent status

**Access:** `/dashboard/inquiries/`

**Permissions:** Administrator or Building Admin roles only

### Step 2: Send OTP for Email Verification

Before accepting an inquiry, the admin must verify the tenant's email address.

**Process:**
1. Click "Send OTP" button for the inquiry
2. Review applicant details in the dialog
3. Confirm sending OTP email
4. System generates a 6-digit OTP code (valid for 5 minutes)
5. Email is sent to the applicant
6. Applicant receives OTP and verifies via `/verify-otp` page

**Business Rules:**
- OTP is automatically generated by backend hooks
- OTP expires after 5 minutes
- OTP can be resent if needed
- Once verified, the button changes to "Verified" and is disabled

### Step 3: Admin Decision - Accept or Reject

After email verification, the admin can make a decision:

#### Option A: Accept Inquiry

**Requirements:**
- Email must be verified (emailVerified = true)
- Status must be "verified"

**Process:**
1. Click "Accept" button
2. Optionally add acceptance notes for audit trail
3. Review applicant information
4. Confirm acceptance
5. System updates inquiry status to "approved"

**Next Steps (Phase 3 - Account Creation):**
- User account is created with "Applicant" role
- Tenant record is linked to user account
- Applicant receives activation email
- Account becomes active in the system

**Audit Trail:**
- Status change timestamp
- Admin who approved
- Acceptance notes (if provided)

#### Option B: Reject Inquiry

**Requirements:**
- Rejection reason is mandatory (minimum 10 characters)

**Process:**
1. Click "Reject" button
2. Enter detailed rejection reason
3. Review rejection consequences
4. Confirm rejection
5. System updates inquiry status to "rejected"
6. Rejection email is sent to applicant with reason

**Consequences:**
- Inquiry status set to "rejected"
- Rejection email sent with reason
- Account creation prevented
- Tenant remains inactive
- Rejection logged for audit trail

**Audit Trail:**
- Status change timestamp
- Admin who rejected
- Rejection reason (required)
- Notification sent confirmation

## Status Flow

```
pending → verified → approved ✓
                  ↘ rejected ✗
```

1. **pending**: Initial state when inquiry is submitted
2. **verified**: Email has been verified via OTP
3. **approved**: Admin has accepted the inquiry (leads to account creation)
4. **rejected**: Admin has rejected the inquiry (permanent)

## Email Notifications

### OTP Verification Email
- **Trigger:** Admin clicks "Send OTP"
- **Recipient:** Applicant's email
- **Content:** 6-digit OTP code, expiration time, verification link
- **Handler:** External automation (n8n) watches for hasSent = false

### Rejection Email
- **Trigger:** Admin rejects inquiry
- **Recipient:** Applicant's email
- **Content:** Rejection reason, contact information
- **Handler:** External automation (n8n) watches for status = "rejected"

### Approval Email (Phase 3)
- **Trigger:** Admin approves inquiry
- **Recipient:** Applicant's email
- **Content:** Account credentials, welcome message, next steps
- **Handler:** Account creation automation

## User Interface

### Inquiry List View

The inquiries page shows:
- Filter by status dropdown (pending, verified, approved, rejected)
- Sort options (name, date)
- Pagination controls
- Data table with all inquiry details
- Action buttons for each inquiry

### Action Dialogs

All action dialogs include:
- Clear titles and descriptions
- Applicant information summary
- Current status display
- Input validation
- Warning/info alerts where appropriate
- Next steps documentation
- Cancel and confirm buttons

## Security & Permissions

### Access Control
- Only administrators and building admins can access inquiry management
- Regular tenants and applicants cannot view or modify inquiries
- All actions are logged for audit purposes

### Validation Rules
- Email verification required before acceptance
- Rejection reason must be at least 10 characters
- Status transitions are enforced
- Proper error handling for all operations

## Technical Implementation

### Frontend Components
- `SendOtpDialog`: Handles OTP email sending
- `AcceptInquiryDialog`: Handles inquiry acceptance
- `RejectInquiryDialog`: Handles inquiry rejection
- Inquiry table with action columns
- Status filtering and sorting

### Backend (PocketBase)
- `inquiry` collection with status field
- `otp` collection for verification codes
- Automatic OTP generation via Go hooks
- Query support for filtering and expansion

### Data Flow
1. Admin action → Frontend mutation
2. PocketBase API call → Update inquiry status
3. Collection update → Triggers automation
4. Email notification sent → Applicant notified
5. Query invalidation → UI updates

## Error Handling

All operations include:
- Try-catch blocks for API calls
- User-friendly error messages via toast notifications
- Validation before submission
- Loading states during async operations
- Proper cleanup on dialog close

## Testing Checklist

- [ ] Admin can view list of pending inquiries
- [ ] Admin can send OTP verification email
- [ ] OTP email is received by applicant
- [ ] Applicant can verify email with OTP
- [ ] Email verification status updates in admin view
- [ ] Admin can accept verified inquiry
- [ ] Acceptance note is stored for audit
- [ ] Admin can reject inquiry with reason
- [ ] Rejection requires minimum 10 character reason
- [ ] Rejection email is sent to applicant
- [ ] Status filters work correctly
- [ ] Sorting works correctly
- [ ] Pagination works correctly
- [ ] Non-admin users cannot access inquiries page
- [ ] All buttons disable appropriately based on status
- [ ] Query invalidation updates UI in real-time

## Future Enhancements

1. **Email Templates**: Custom email templates for notifications
2. **Bulk Actions**: Accept/reject multiple inquiries at once
3. **Advanced Filters**: Filter by date range, unit type, etc.
4. **Export**: Export inquiry data to CSV/Excel
5. **Analytics**: Dashboard with inquiry metrics
6. **Automation**: Auto-approve based on criteria
7. **Notifications**: In-app notifications for admins
8. **History**: View audit log of all status changes

## Related Documentation

- [OTP Verification System](./otp-verification.md)
- [Phase 3: Account Creation](./account-creation.md)
- [Email Automation Setup](./email-automation.md)
- [PocketBase Collections](./pocketbase-schema.md)
